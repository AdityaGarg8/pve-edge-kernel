name: Kernel Build

on: workflow_dispatch

jobs:
  build:
    name: Build
    runs-on: ubuntu-22.04
    if: ${{ !contains(github.event.head_commit.message, 'skip ci') }}
    steps:
    - name: 'Checkout Repo'
      uses: actions/checkout@v3
    - name: Get sources
      run: sudo apt update && sudo apt install devscripts debhelper equivs git
    - name: Build Kernel
      run: 
        git clone https://github.com/t2linux/linux-t2-patches.git
        mkdir patches
        cp ./linux-t2-patches/*patch ./patches
        cd patches
        ls > $HOME/list.conf
        cd -
        sed -i -e 's/^/pve\//' $HOME/list.conf
        git clone https://github.com/fabianishere/pve-edge-kernel
        cp ./linux-t2-patches/*patch ./pve-edge-kernel/debian/patches/pve
        echo >> ./pve-edge-kernel/debian/patches/series.linux
        cat $HOME/list.conf >> ./pve-edge-kernel/debian/patches/series.linux
        cat ./linux-t2-patches/extra_config >> ./pve-edge-kernel/debian/config/config.pve
        cat ./pve-edge-kernel/debian/patches/series.linux
        echo
        cat ./pve-edge-kernel/debian/config/config.pve
        git checkout v6.0.x
        #git submodule update --init --depth=1 --recursive linux
       # git submodule update --init --recursive
     #   debian/rules debian/control
       # sudo mk-build-deps -i
      #  debuild -ePVE* --jobs=auto -b -uc -us
      #  tree -a
    #    cd
    #    tree -a
    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: debs
        path: "*.deb"
