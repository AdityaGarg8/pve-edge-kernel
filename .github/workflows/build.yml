name: Kernel Build

on: workflow_dispatch

jobs:
  build:
    name: Build
    runs-on: ubuntu-22.04
    if: ${{ !contains(github.event.head_commit.message, 'skip ci') }}
    steps:
    - name: Clean Workspace
      run: rm -rf *.deb *.ddeb *.build *.buildinfo *.changes
    - name: Get sources
      run: sudo apt update && sudo apt install devscripts debhelper equivs git
    - name: Build Kernel
      run: |
        git clone https://github.com/fabianishere/pve-edge-kernel
        cd pve-edge-kernel
        git checkout v6.0.x
        git submodule update --init --depth=1 --recursive linux
        git submodule update --init --recursive
        debian/rules debian/control
        sudo mk-build-deps -i
        debuild -ePVE* --jobs=auto -b -uc -us
        tree -a
        cd
        tree -a
    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: debs
        path: "*.deb"
